version: '3.8'

services:
  milo:
    build: .
    container_name: milo
    ports:
      - "8080:80"
    env_file:
      - .env
    volumes:
      - ./data:/var/www/html/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/src/discord_interactions.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Cron service to process messages
  milo-cron:
    build: .
    container_name: milo-cron
    env_file:
      - .env
    volumes:
      - ./data:/var/www/html/data
    restart: unless-stopped
    command: >
      bash -c "
      echo '* * * * * php /var/www/html/src/cron_process_messages.php >> /var/log/cron.log 2>&1' > /etc/cron.d/milo-cron &&
      chmod 0644 /etc/cron.d/milo-cron &&
      crontab /etc/cron.d/milo-cron &&
      touch /var/log/cron.log &&
      cron &&
      tail -f /var/log/cron.log
      "
